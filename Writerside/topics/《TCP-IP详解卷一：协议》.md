# 《TCP/IP详解卷一：协议》

## 第一章 概述 ###

### 分层 ###
|-----|----|
|层次|功能|
|应用层|Telnet、FTP和e-mail|
|运输层|TCP和UDP|
|网络层|IP、ICMP和IGMP|
|链路层|设备驱动程序及接口卡|

1. 链路层：一般指设备驱动程序及接口卡，处理一些物理传输媒介的细节。
2. 网络层：一般用于处理分组在网络中的活动。
3. 运输层：一般用于两台主机上应用程序间的**端到端**的通信。

|----|----|----|
|协议|特点|处理方式|
|TCP|可靠性高|数据分组->发送到网络层->确认收到->再进行相关的时钟设置等->发送到下一层|
|UDP|可靠性低|数据分组->发送到下一层| 

**任意的可靠性必须由*应用层*提供**

4. 应用层： 一般用于处理特定的应用程序细节。

此处，顶层（应用层）与下三层的不同在于，**顶层**只需要关心**应用程序**的细节，**下三层**处理**通信细节**。


局域网上运行FTP的两台主机

![image.png](image.png)

服务模式：Client - Server: Client -^请求^-> Server, Server -^响应^-> Client

|---|---|---|
|协议|层次|
|FTP|应用层|
|TCP|运输层|
|IP|网络层|
|以太网协议|链路层| 

**TCP/IP**为一个*协议族*(Internet Protocol Suite)

|---|---|
|链接互联网的方法|层次|
|路由器(最简单)|网路层|
|网桥|链路层|


![image_1.png](image_1.png)

通过路由器(Router)连接的两个网络

**在TCP/IP协议族中，网络层IP提供的是一种不可靠的服务。**

### TCP/IP的分层 ###
![image_2.png](image_2.png)

TCP/IP协议族中不同层次的协议

虽然**TCP**使用不可靠的IP服务，但是它却提供一种可靠的运输层服务。

**UDP**为应用程序发送和接收数据报。

**IP**是网络层上的主要协议，同时被TCP和UDP使用，**TCP**和**UDP**的每组数据都通过端系统和每个中间路由器中的**IP**层在互联网中进行传输

**ICMP**是**IP**协议的附属协议，**IP**层用它来与其他主机或路由器交换错误报文和其他重要信息。

**IGMP**是Internet组管理协议，它用来把一个**UDP**数据报多播到多个主机。

**ARP**(地址解析协议)和**RARP**(逆地址解析协议)是某些网络接口使用的特殊协议，用来转换**IP**层和网络接口层的地址。

### 互联网的地址 ###
互联网上的每个接口必须有一个唯一的Internet地址（也称作IP地址，其长度为32bit）。

IP地址的结构

![image_3.png](image_3.png)

|---|---|
|类型|范围|
|A|**0**.0.0.0 到 **127**.255.255.255| 
|B|**128**.0.0.0 到 **191**.255.255.255| 
|C|**192**.0.0.0 到 **223**.255.255.255|
|D|**224**.0.0.0 到 **239**.255.255.255|
|E|**240**.0.0.0 到 **247**.255.255.255|
|结论|可以通过观察这些地址的**第一个十进制整数**来区分各个类型的地址|

这些32位的地址通常写成四个十进制的数，其中每个整数对应一个字节——**点分十进制表示法(Dotted decimal notation)**

重点：多接口主机具有多个IP地址，其中**每个接口都对应一个IP地址**。

|---|---|
|IP地址类型|目的端|
|单播地址|单个主机|
|广播地址|目标网络上的所有主机|
|多播地址|同一组内的所有主机|

### 域名系统 ###
在*TCP/IP*领域中，**域名系统(DNS)是一个分布的数据库**，由它来提供**IP地址**和**主机名**之间的**映射**信息。



### 封装 ###
当应用程序用**TCP**传送数据时，数据被送入**协议栈**中，然后逐个通过每一层直到被当作一串比特流送入网络。

![image_6.png](image_6.png)

TCP传给IP的数据单元称作TCP报文段（TCP段，TCP segment)。

IP传给网络接口层的数据单元称作IP数据报（IP datagram）。

通过以太网传输的比特流叫做帧（Frame）。

以太网数据帧的**物理特性**是其长度必须在**46 ~ 1500字节**之间。

UDP数据与TCP数据基本一致。唯一不同在于UDP传给IP的信息单元称作**UDP数据报（UDP datagram）**，而且**UDP的首部长为8字节**。

由于TCP、UDP、ICMP、IGMP都要向IP传送数据，因此IP必须在生成的IP首部中加入**某种标识**，用于表明数据**属于哪一层**。
为此，IP在首部中存入一个长度为**8bit**的数值，称作**协议域**。

|---|---|
|bit值|协议|
|1|ICMP协议|
|2|IGMP协议|
|6|TCP协议|
|17|UDP协议|

类似地，许多应用程序在使用TCP或UDP来传送数据时，运输层协议在生成报文首部时要存入一个应用程序的标识符。
TCP和UDP都用一个16bit的端口号来表示不同的应用程序。TCP和UDP把源端口号和目的端口号分别存入报文首部中。

网络接口在发送和接收IP、ARP和RARP数据时，也必须在以太网的帧首部加入某种形式的标识，以指明生成数据的网络层协议。因此，以太网的帧首部也有一个16bit的帧类型域。

### 分用 ###
当目标主机收到一个以太网数据帧时，数据就开始从协议栈中有底向上升，同时去掉各层协议加上的报文首部。

每层协议盒都要去检查报文首部中的协议标识，以确定接收数据的上层协议。

![image_7.png](image_7.png)


### 客户-服务器模型 ###
模型设计目的：让服务器为客户提供一些**特定**的服务。

|---|---|
|服务器类型|工作流程|优缺点|
|重复型 for UDP|等待request -> 处理request -> 发送response -> 重复上述流程|缺点：当在服务器处理request时，不能为其他用户提供服务|
|并发型 for TCP|等待request -> 启动一个新的服务器处理request（其余操作由操作系统完成） -> 重复上述流程 |优点：可以根据需求生成其他服务其为用户提供服务|

### 端口号 ###
**服务器**一般都是通过知名**端口号**来识别的。

|---|---|---|---|---|
|名字|TCP端口号|UDP端口号|RFC|描述|
|echo|7|7|862|服务器返回客户发送的所有内容|
|discard|9|9|863|服务器丢弃客户发送的所有内容|
|daytime|13|13|867|服务器以可读形式返回时间和日期|
|chargen|19|19|864|当客户发送一个数据报时，TCP服务器发送一串连续的字符流，直到客户中断连接，UDP服务器发送一个随机长度的数据报|
|time|37|37|868|服务器返回一个二进制形式的32bit数，表示从UTC时间1900年1月1日午夜至今的秒数|

从上表可以看出，当使用TCP和UDP提供相同的服务时，一般选择相同的端口号。

注：之所以端口号都是奇数，是因为这些端口号都是从NCP端口号派生出来的（NCP,即网络控制协议，时ARPANET的运输层协议，是TCP的前身）。
NCP是单工的，不是全双工的，因此每个应用程序需要两个连接，需要预留一对奇数和偶数端口号，当TCP和UDP成为标准的运输层协议时。每个应用程序只需要一个端口号，因此就使用了NCP中的奇数。

### 互联网 ###
**internet**的意思是用**一个共同的协议族把多个网络连接在一起**。而**Internet**指的是世界范围内通过TCP/IP互相通信的**所有主机集合**。

Internet是一个internet，但internet不等于Internet。

### 小结 ###
1. TCP/IP协议族分为四层：链路层、网络层、运输层和应用层，每一层各司其职。

2. 在TCP/IP中，网络层和运输层之间的区别是最关键的：网络层（IP）提供点到点的服务，而运输层（TCP和UDP）提供端到端服务。

3. 一个互联网是网络的网络。构造互联网共同的基石是路由器，它们在IP层把网络连在一起。

4. 在一个互联网上，每个接口都用IP地址来标识，尽管用户习惯使用主机名而不是IP地址。

5. 域名系统为主机名和IP地址之间提供动态的映射。端口号用来标识互相通信的应用程序。服务器使用知名端口号，而客户使用特定的端口号。

## 第二章 链路层 ##

链路层主要的三个作用：
1. 为IP模块发送和接受IP数据报
2. 为ARP模块发送ARP请求和接收ARP应答
3. 为ARP发送RARP请求和接收RARP应答

TCP/IP支持多种不同的链路层协议，这取决于网络所使用的硬件。

### 以太网和IEEE 802封装
以太网采用一种称作*CSMA/CD*的接入方法，即带冲突检测的载波侦听多路接入,其速率为**10Mb/s**，地址为48bit。



### 尾部封装 ###


### SLIP: 串行线路IP ###






























