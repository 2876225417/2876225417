# 第一章 基础知识

## 1.1 机器语言
**机器语言是机器指令的集合。**  

机器指令就是一台计算机可以正确执行的命令，**机器指令是一列二进制数字**，
计算机将其转换为一列高低电平，使计算机的电子器件受到驱动，然后进行运算。

在现代的PC机中，负责执行上述操作的硬件为CPU(_Central Processing Unit_， 中央处理单元)。  

**一般来说，一个计算机是由CPU及其它受CPU直接或间接控制的芯片、器件、设备组成的计算机系统。**

不同的CPU，其硬件设计和内部结构都是不相同的，因此就需要用不同的电平脉冲对其进行控制，使其工作，所以**每一种CPU都有自己的机器指令集，也就是机器语言。**

早机器的程序设计使用的机器语言，也就是使用0和1来进行一系列的编程工作，这导致书写和阅读机器码十分困难，并且在后期的调试过程中也会显得十分麻烦，为了解决这样的问题，在后续就引入了汇编语言。

## 1.2 汇编语言

**汇编语言的主体使汇编指令。**  
因为汇编语言的出现主要是为了简化机器码的表示，所以汇编指令和机器指令的差别主要在于指令的表示方法上。

例如：
* 操作： 寄存器 BX 的内容发送到 AX 中
* 机器指令： 1000100111011000
* 汇编指令： mov ax, bx

> 寄存器：在CPU中可以存储的器件，一个CPU中有多个寄存器。
> AX 是其中一个寄存器的代号， BX 是另一个寄存器的代号。

![Assembly0.png](Assembly0.png)

## 1.3 汇编语言组成

汇编语言由以下3类指令组成：
1. **汇编指令**：机器码的助记符，有对应的机器码。
2. **伪指令**：没有对应的机器码，由编译器执行，计算机并不执行。
3. **其他符号**：如+、-、*、/等，由编译器识别，没有对应的机器码。  

**汇编语言的核心是汇编指令，它决定了汇编语言的特性。**

## 1.4 存储器

CPU 是计算机的核心硬件，它控制整个计算机的运行并进行计算。  
要让一个CPU工作， 就必须要向它提供指令和数据，而**指令和数据会存放在存储器中**，即内存。

## 1.5 指令和数据

指令和数据是应用上的概念，它们都是二进制信息，CPU在工作时会把有的信息的看作指令，有的信息看作数据。

例如：内存中的一段二进制信息 1000100111011000，计算机(CPU)可以既可以将其当作数据进行计算，也可以当作指令执行
* 1000100111011000 -> 89D8H(数据)
* 1000100111011000 -> mov ax, bx(程序)

## 1.6 存储单元

存储器被划分为若干个存储单元。每个存储单元从0开始编号。
对于一个有128个存储单元的存储器而言，其编号顺序如下图所示：

![Assembly1.png](Assembly1.png)

8bit(比特)组成1Byte(字节)，存储器中的存储单元可以存储1Byte，即8个二进制位(bit)，对于上面的存储器而言，它可以存储128Byte。  
对于拥有128个存储单元的存储器，其容量为128个字节(Byte)。

|----|----|
|存储单位|换算关系|
|KB|1KB=1024B|
|MB|1MB=1024KB|
|GB|1GB=1024MB|
|TB|1TB=1024GB|

## 1.7 CPU对存储器的读写

CPU 要从内存中读取数据，首先要确定存储单元的地址，同时也要确定是对哪一个器件进行操作，进行哪种操作。

CPU 想要进行数据的读写，必须和芯片进行下面三类信息的交互：
* 存储的单元的地址(地址信息)
* 器件的选择，读或写的命令(控制信息)
* 读或写的数据(数据信息)

在计算机中，电信号通过导线进行传输，这种连接CPU和其他芯片的导线被称为总线。  
在物理层面上来讲，就是一根根导线的集合。
根据传送信息的不同，总线从逻辑上又分为3类，地址总线、控制总线和数据总线。

CPU 从 3 号单元中读取数据的过程如下：

![Assembly2.png](Assembly2.png)

读操作：
1. CPU 通过**地址线将地址信息 3 发出**
2. CPU 通过**控制线发出内存读命令**，选中存储芯片，并通知它，将要从中读取数据。
3. 存储器将 3 号单元中的**数据 8 通过数据线送入 CPU**。

写操作：
1. CPU 通过地址线将地址信息 3 发出。
2. CPU 通过控制线发出内存写命令，选中存储芯片，并通知它，将要向其中写入数据。
3. CPU 通过数据线将数据 26 送入内存的 3 号单元中。

对于 8086CPU， 下面的机器码，可以实现从 3 号单元中读数据：  
机器码： 101000010000001100000000  
含义：   从 3 号单元读取数据送入寄存器 AX

完成上述操作后，再进行写操作：  
机器码：        101000010000001100000000  
对应的汇编指令：  MOV AX, [3]
含义：          传送 3 号单元的内容至 AX

## 1.8 地址总线

CPU 是通过地址总线来指定存储器单元的，并且地址总线可以传输的不同信息数量决定了 CPU 可以对多少个存储单元进行寻址。

先假设，一个 CPU 有 10 根地址总线，一根导线能够传递的稳定状态有两种，高电平和低电平，
用二进制表示就是1或0，10 根导线可以传送 10 位二进制数据，而 10 位二进制数可以表示 2^10^ (0-1023, 即1024)个不同的数据。

![Assembly3.png](Assembly3.png)

上图展示了一个具有 10 根地址线的 CPU 向内存发出地址信息 11 时 10 根地址线上传送的二进制信息。


```
地址线0---------2^0-------  
地址线1---------2^1-------  
地址线2---------2^2-------  
地址线3---------2^3-------  
地址线4---------2^4-------  
地址线5---------2^5-------  
地址线6---------2^6-------  
地址线7---------2^7-------  
地址线8---------2^8-------  
地址线9---------2^9-------  
```


对应地，当访问地址为 12 时的内存单元时，地址总线上传输的内容为：

![Assembly4.png](Assembly4.png)

一个 CPU 有 N 根地址线，则可以说这个 CPU 的地址总线的宽度为 N，这样的 CPU 最多可以寻找 2 的 N 次方个内存单元。


## 1.9 数据总线

CPU 与内存或其他芯片之间的数据传送是通过数据总线来进行的。数据总线的宽度决定了 CPU 和外界的数据传输速度。  
8 根数据总线一次可以传送一个 8 位二进制数据(即 1 Byte)，16 根数据总线一次可传送 2 Byte，即 1 根数据总线一次可传送 1 bit。  

8088CPU 的数据总线宽度为 8， 8086CPU 的数据总线宽度为16，当向内存中写入数据 89D8H 时，数据传输过程如下：

![Assembly5.png](Assembly5.png)

![Assembly6.png](Assembly6.png)

由上可知，8086 有 16 根数据线，可一次传输16位数据，所以可以一次传输数据 89D8H；而 8088 只有 8 根数据线，
一次只能传输 8 位数据，所以向内存写入数据 89D8H 时需要进行两次数据传输。
   

> 补充： 此处如何对传输的数据进行划分   
> 1. 对于偶数字节的划分，将其划分为高低位，前一半为高位，后一半为低位。  
> 2. 对于奇数字节的划分，将其均等化分为高中低位。
> 3. 在数据传输的过程中，如果总线宽度不够一次传输所有数据，据需要分高低位多次传输。

```C++
    /* 例如对一个2字节(16位)数据
       使用位运算来提取高低字节
    */
    unsigned char data = 0x89D8;
    unsigned char high_byte = (data >> 8) & 0xFF;   // 取高字节 
    unsigned char low_byte = data & 0XFF;           // 取低字节
```

## 1.10 控制总线
CPU 对外部芯片的控制是通过控制总线来实现的。  
此处控制总线是一些不同控制线的集合。有多少根控制总线，就意味着 CPU 提供了对多种外部芯片的多种控制，
所以控制总线决定了 CPU 对外部芯片的控制能力。

内存的读或写命令是由几根控制线综合发出的，其中就有一根成为“读信号输出”的控制线负责由 CPU 向外传送读信号，
CPU 向该控制线上输出低电平表示将要读取数据；有一根称为“写信号输出”的控制线则负责传送写信号。

## 1.1 ~ 1.10 小结
1. 汇编指令是机器指令的助记符。
2. 每一种 CPU 都有自己的汇编指令集。
3. CPU 可以直接使用的信息在存储器中存放。
4. 在存储器中指令和数据没有任何区别，都是二进制信息。
5. 存储单元从0开始按顺序编号。
6. 一个存储单元可以存储8bit，即1Byte、8位二进制数。
7. 1Byte=8bit 1KB=1024B 1MB=1024KB 1GB=1024MB。 
8. 每一个 CPU 芯片都有许多针脚，这些针脚和总线相连，或者说，这些针脚引出总线。一个 CPU 可以引出3种总线的宽度标志了这个 CPU 的不同方面的性能:  
   * 地址总线的宽度决定了 CPU 的寻址能力；
   * 数据总线的宽度决定了 CPU 与其他器件进行数据传送时的一次数据传送量；
   * 控制总线的宽度决定了 CPU 对系统中其他芯片的控制能力。


## 小测 1.1 {id="1-1_1"}

1. 一个 CPU 的寻址能力为 8KB，那么它的地址总线的宽度为 13。
> 寻址能力为 8KB，即2^13^ 字节，所以地址总线宽度为13位。
2. 1KB 的存储器由 1024 个存储单元组成，存储单元的编号从 0 到 1023。
> 1KB = 1024字节(Byte)，每个存储单元存储1字节(Byte)，因此有1024个存储单元。
3. 1KB的存储器可以存储8192bit，1024个Byte。
4. 1GB、1MB、1KB分别是1024*1024*1024、1024*1024、1024个Byte
5. 8080、8088、80286、80386的地址总线宽度分别为16根、20根、24根、32根，则它们的寻址能力分别为： 64KB、 1MB、 16MB、 4GB。
> 寻址能力为2^地址总线宽度^ 字节：  
> * 8080: 2^16^ = 64KB
> * 8088: 2^20^ = 1MB
> * 80286: 2^24^ = 16MB
> * 80386: 2^32 = 4GB
6. 8080、8088、8086、80826、80386的数据总线宽度分别为8根、8根、16根、16根、32根，则他们一次可以传送的数据为: 1B、 1B、 2B、 2B、 4B。
> 数据总线宽度决定一次可以传送的数据位数，每 8 位为 1 字节
7. 从内存中读取 1024 字节的数据，8086至少要读 512 次， 80386至少要读 256 次。
> 8086的数据总线宽度为 16 位(2 字节)
> 80386的数据总线宽度为 32 位(4 字节)
8. 在存储器中，数据和程序以 二进制 形式存放。

## 1.11 主板
在 PC 机中， 主板上集成了一些核心器件和主要器件，这些器件通过总线(地址总线、数据总线、控制总线)相连。  
这些器件包括但不限于 CPU、 存储器、 外围芯片组、 扩展插槽等。

## 1.12 接口卡
在计算机系统中，CPU 控制所有可用程序控制其工作的设备。CPU 不能对外部设备直接进行控制，
直接控制这些设备进行工作的是插在扩展插槽上的接口卡，扩展插槽通过总线和 CPU 相连，
所以接口卡也通过总线同 CPU 相连，CPU 可以直接控制这些接口卡，从而实现 CPU 对外部设备的间接控制。

## 1.13 各类存储器芯片
根据存储器的读写属性可以将其分为两类：
* 随机存储器(RAM)：随机存储器可读可写，但必须带电存储，关机后存储内容丢失
* 只读存储器(ROM)：只读存储器只能读取不能写入，关机后其中的内容不丢失。

根据存储器的功能和连接方式上可以分为以下几类：
* 随机存储器
> 用于存放供 CPU 使用的绝大部分程序和数据， 主随机存储器一般由两个位置上的 RAM组成
> ，装在主板上的 RAM 和插在扩展插槽上的 RAM。
* 装有 BIOS (Basic Input/Output System，基本输入/输出系统)的ROM
> BIOS 是由主板和各类接口卡厂商提供的软件系统，可以通过它利用该硬件设备进行最基本的输入输出。
* 接口卡上的 RAM
> 某些接口卡需要大批量输入、输出数据进行暂时存储，在其上装有 RAM。
> 最典型的是显卡上的RAM，一般称之为显存，显卡随时将显存中的数据向显示器上输出。

PC 系统中各类存储器的逻辑连接情况如下所示：

![Assembly_8.png](Assembly_8.png)



## 1.14 内存地址空间
内存地址空间(Memory Address Space)指的是计算机系统中内存单元的一个空逻辑排列，
用于表示可以被处理器访问的所有存储位置。  
举个例子，一个 CPU 的地址总线宽度为 10， 那么可以寻址 1024 个内存单元，
这 1024 个可寻到的内存单元就构成这个 CPU 的内存地址空间。

前面提及的存储器，都有以下两个共同点：
* 都和 CPU 的总线相连
* CPU 对它们进行读或写的时候通过控制线发出内存读写命令

CPU 在控制这些存储器时，把它们当作内存来对待，把它们看作一个由若干存储单元组成的逻辑存储器，
这个逻辑存储器就是内存地址空间。

CPU 将系统中各类存储器看作一个逻辑存储器的情况如下图所示：

![Assmebly_8.png](Assmebly_8.png)

在上图中，所有的物理存储器被看作一个由若干个存储单元组成的逻辑存储器，每个物理存储器在这个逻辑存储器中占有一段地址空间。  
CPU 在这段地址空间中读写数据，实际就是在相对应的物理存储器中读写数据。  
假设上图中的内存地址空间的地址段分配如下:
* 地址 0 ~ 7FFFH 的 32KB 空间为主随机存储器的地址空间
* 地址 8000H ~ 9FFFH 的 8KB 空间为显存的地址空间
* 地址 A000H ~ FFFFH 的 24KB 空间为各个 ROM 的地址空间

这样， CPU 可以根据不同的地址段对不同的存储器进行操作：
* CPU 向内存地址为 1000H 的内存单元中写入数据，这个数据就被写入主随机存储器中
* CPU 向内存地址为 8000H 的内存单元中写入数据，这个数据就被写入显存中，然后会被显卡输出到显示器上
* CPU 向内存地址为 C000H 的内存单元中写入数据的操作没有结果，C000H单元中的内容不会被改变，C000H单元实际上就是 ROM存储器(只读存储器) 中的一个单元

内存地址空间的大小受 CPU 地址总线宽度的限制。 8086CPU的地址总线宽度为20， 可以传送 2^20^ (从 0 至 2^20^ - 1) 个不同的地址信息。
即可以定位 2^20^ 个内存单元，则8086CPU 的内存地址空间大小为 1MB(1024 * 1024Byte)，同理80386CPU的地址总线宽度为 32，
则内存地址空间最大为4GB(1024 * 1024 * 1024 * 4Byte)。

在基于一个计算机硬件系统编程时，必须知道这个系统中的内存地址分配情况。因为当对某类存储器进行读写操作时，必须知道它的第一个和最后一个单元的地址，
才能保证读写操作是在预期的存储器中进行的。

不同的计算机系统的内存地址空间的分配情况是不同的，下图展示的是 8086PC 机内的地址空间分配的情况：

![Assembly_9.png](Assembly_9.png)

从上图中可以看出：
* 从地址0 ~ 9FFFF的内存单元中读取数据，实际上就是在读取主随机存储器中的数据
* 向地址A0000 ~ BFFF的内存单元中写入数据，就是向显存中写入数据，这些数据会被显卡输出到显示器上
* 向地址C000 ~ FFFF的内存单元中写入数据的操作是无效的，因为这个地址段对应的是ROM存储器(只读存储器)，但是可以向这个地址段进行数据读取的操作

> **内存地址空间**  
> 因为程序最终是运行在 CPU 上的，所以当在使用汇编语言进行编程时，必须要从 CPU 的角度考虑问题。  
> 对 CPU 而言，系统中所有存储器中的存储单元都处于一个统一的逻辑存储器中，它的容量受 CPU 的寻址能力(地址总线宽度)的限制。  
> 这个逻辑存储器就是内存地址空间。

